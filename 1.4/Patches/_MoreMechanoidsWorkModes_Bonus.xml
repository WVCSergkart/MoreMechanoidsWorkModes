<?xml version="1.0" encoding="utf-8" ?>
<Patch>

	<!-- =========================================================== -->

	<Operation Class="WVC.PatchOperation_MMWM">
		<settingName>WVC_EscortIfEnemyWorkAndRecharge</settingName>
		<active Class="PatchOperationSequence">
			<operations>
				<li Class="PatchOperationAdd">
					<xpath>/Defs/ThinkTreeDef[defName="Mechanoid" or defName="RM_Mechanoid_Caretaker" or defName="RM_Mechanoid_Sentinel"]/thinkRoot/subNodes/li[@Class="ThinkNode_ConditionalPlayerControlledMech"]/subNodes/li[@Class="ThinkNode_ConditionalNotFormingCaravan"]/subNodes</xpath>
					<value>
					  <li Class="ThinkNode_ConditionalWorkMode" MayRequire="Ludeon.RimWorld.Biotech">
						<workMode>WVC_EscortIfEnemyWorkAndRecharge</workMode>
						<subNodes>
						  <!-- Enemy = true -->
						  <li Class="WVC_WorkModes.ThinkNode_ConditionalEnemyOnMap">
							<subNodes>
							  <li Class="WVC_WorkModes.JobGiver_SmartAIDefendOverseer" />
							  <li Class="WVC_WorkModes.JobGiver_SmartAIFollowOverseer"/>
							  <li Class="WVC_WorkModes.JobGiver_SmartAIWaitWithOverseer" />
							  <li Class="WVC_WorkModes.JobGiver_SmartWanderOverseer" />
							</subNodes>
						  </li>
						  <!-- Enemy = false -->
						  <li Class="JobGiver_SeekAllowedArea" />
						  <li Class="JobGiver_GetEnergy_Charger" />
						  <li Class="JobGiver_Work">
							<emergency>true</emergency>
						  </li>
						  <li Class="JobGiver_Work" />
						  <!-- Go to smart charge -->
						  <li Class="WVC_WorkModes.JobGiver_GetEnergy_Charger">
							<tickInterval>625</tickInterval>
						  </li>
						  <!-- Go to spot -->
						  <!-- <li Class="WVC_WorkModes.JobGiver_GoToClosetShutdownSpot"> -->
							<!-- <spotDefName>WVC_IOMSS_WorkAndRecharge</spotDefName> -->
							<!-- <backupSpotDefName>WVC_IdleOptimization_MechanoidShutdownSpot</backupSpotDefName> -->
						  <!-- </li> -->
						  <li Class="WVC_WorkModes.JobGiver_GoToShutdownZone">
							<workModeType>Work</workModeType>
							<spotDefName>WVC_IOMSS_WorkAndRecharge</spotDefName>
							<backupSpotDefName>WVC_IdleOptimization_MechanoidShutdownSpot</backupSpotDefName>
						  </li>
						  <!-- Shutdown long -->
						  <li Class="WVC_WorkModes.JobGiver_GetEnergy_SelfShutdown">
							<forced>true</forced>
						  </li>
						</subNodes>
					  </li>
					</value>
				</li>
				<li Class="PatchOperationAdd">
					<xpath>/Defs</xpath>
					<value>
					  <MechWorkModeDef ParentName="WVC_MMVM_MechWorkMode_Base">
						<defName>WVC_EscortIfEnemyWorkAndRecharge</defName>
						<label>escort if enemy, work and recharge</label>
						<description>Mechanoids, regardless of their type, will accompany the overseer when an enemy is in their zone of operation. Otherwise, they will work.

&lt;color=#f5ffa2&gt;Type:&lt;/color&gt; Combat
&lt;color=#f5ffa2&gt;Enemy searching:&lt;/color&gt; Yes
&lt;color=#f5ffa2&gt;Shutdown:&lt;/color&gt; Yes
&lt;color=#f5ffa2&gt;Smart charging:&lt;/color&gt; Yes</description>
						<uiOrder>170</uiOrder>
						<iconPath>WVC/UI/MechWork/EscortIfEnemyWorkAndRecharge</iconPath>
						<workerClass>WorkModeDrawer_Escort</workerClass>
					  </MechWorkModeDef>
					</value>
				</li>
				<li Class="PatchOperationAdd">
					<xpath>/Defs/ThingDef[defName="WVC_IOMSS_WorkAndRecharge"]/descriptionHyperlinks</xpath>
					<success>Always</success>
					<value>
					  <MechWorkModeDef>WVC_EscortIfEnemyWorkAndRecharge</MechWorkModeDef>
					</value>
				</li>
			</operations>
		</active>
		<!-- <deActive Class="PatchOperationSequence"> -->
			<!-- <operations> -->
				<!-- <li Class="PatchOperationRemove"> -->
					<!-- <xpath>/Defs/MechWorkModeDef[defName="WVC_EscortIfEnemyWorkAndRecharge"]</xpath> -->
					<!-- <success>Always</success> -->
				<!-- </li> -->
				<!-- <li Class="PatchOperationRemove"> -->
					<!-- <xpath>/Defs/ThingDef[@ParentName="WVC_IdleOptimization_MechanoidShutdownSpot"]/descriptionHyperlinks</xpath> -->
					<!-- <success>Always</success> -->
				<!-- </li> -->
			<!-- </operations> -->
		<!-- </deActive> -->
	</Operation>

	<!-- =========================================================== -->

	<Operation Class="WVC.PatchOperation_MMWM">
		<settingName>WVC_EscortIfDraftedOrDowned</settingName>
		<active Class="PatchOperationSequence">
			<operations>
				<li Class="PatchOperationAdd">
					<xpath>/Defs/ThinkTreeDef[defName="Mechanoid" or defName="RM_Mechanoid_Caretaker" or defName="RM_Mechanoid_Sentinel"]/thinkRoot/subNodes/li[@Class="ThinkNode_ConditionalPlayerControlledMech"]/subNodes/li[@Class="ThinkNode_ConditionalNotFormingCaravan"]/subNodes</xpath>
					<value>
					  <li Class="ThinkNode_ConditionalWorkMode" MayRequire="Ludeon.RimWorld.Biotech">
						<workMode>WVC_EscortIfDraftedOrDowned</workMode>
						<subNodes>
						  <!-- Drafted == true -->
						  <li Class="WVC_WorkModes.ThinkNode_ConditionalDrafted">
							<subNodes>
							  <li Class="WVC_WorkModes.JobGiver_SmartAIDefendOverseer" />
							  <li Class="WVC_WorkModes.JobGiver_SmartAIFollowOverseer"/>
							  <li Class="WVC_WorkModes.JobGiver_SmartAIWaitWithOverseer" />
							  <li Class="WVC_WorkModes.JobGiver_SmartWanderOverseer" />
							</subNodes>
						  </li>
						  <!-- Drafted == false -->
						  <!-- Downed == true -->
						  <li Class="WVC_WorkModes.ThinkNode_ConditionalDowned">
							<subNodes>
							  <li Class="WVC_WorkModes.JobGiver_SmartAIDefendOverseer" />
							  <li Class="WVC_WorkModes.JobGiver_SmartAIFollowOverseer"/>
							  <li Class="JobGiver_AIFightEnemies">
								<targetAcquireRadius>65</targetAcquireRadius>
								<targetKeepRadius>72</targetKeepRadius>
							  </li>
							  <!-- <li Class="WVC_WorkModes.JobGiver_SmartAIWaitWithOverseer" /> -->
							  <li Class="WVC_WorkModes.JobGiver_SmartWanderOverseer" />
							</subNodes>
						  </li>
						  <!-- Downed == false -->
						  <li Class="JobGiver_SeekAllowedArea" />
						  <li Class="JobGiver_GetEnergy_Charger" />
						  <!-- Go to smart charge -->
						  <li Class="WVC_WorkModes.JobGiver_GetEnergy_Charger">
							<tickInterval>625</tickInterval>
						  </li>
						  <!-- Go to spot -->
						  <!-- <li Class="WVC_WorkModes.JobGiver_GoToClosetShutdownSpot"> -->
							<!-- <spotDefName>WVC_IOMSS_WaitEnemy</spotDefName> -->
							<!-- <backupSpotDefName>WVC_IdleOptimization_MechanoidShutdownSpot</backupSpotDefName> -->
						  <!-- </li> -->
						  <li Class="WVC_WorkModes.JobGiver_GoToShutdownZone">
							<workModeType>Combat</workModeType>
							<spotDefName>WVC_IOMSS_WaitEnemy</spotDefName>
							<backupSpotDefName>WVC_IdleOptimization_MechanoidShutdownSpot</backupSpotDefName>
						  </li>
						  <!-- Shutdown long -->
						  <li Class="WVC_WorkModes.JobGiver_GetEnergy_SelfShutdown">
							<forced>true</forced>
						  </li>
						</subNodes>
					  </li>
					</value>
				</li>
				<li Class="PatchOperationAdd">
					<xpath>/Defs</xpath>
					<value>
					  <MechWorkModeDef ParentName="WVC_MMVM_MechWorkMode_Base">
						<defName>WVC_EscortIfDraftedOrDowned</defName>
						<label>escort if drafted or downed</label>
						<description>Mechanoids, regardless of type, will accompany an overseer if it is drafted or downed.

&lt;color=#f5ffa2&gt;Type:&lt;/color&gt; Combat
&lt;color=#f5ffa2&gt;Enemy searching:&lt;/color&gt; No
&lt;color=#f5ffa2&gt;Shutdown:&lt;/color&gt; Yes
&lt;color=#f5ffa2&gt;Smart charging:&lt;/color&gt; Yes</description>
						<uiOrder>175</uiOrder>
						<iconPath>WVC/UI/MechWork/EscortIfDraftedOrDowned</iconPath>
						<workerClass>WorkModeDrawer_Escort</workerClass>
					  </MechWorkModeDef>
					</value>
				</li>
				<li Class="PatchOperationAdd">
					<xpath>/Defs/ThingDef[defName="WVC_IOMSS_WaitEnemy"]/descriptionHyperlinks</xpath>
					<success>Always</success>
					<value>
					  <MechWorkModeDef>WVC_EscortIfDraftedOrDowned</MechWorkModeDef>
					</value>
				</li>
			</operations>
		</active>
	</Operation>

</Patch>
